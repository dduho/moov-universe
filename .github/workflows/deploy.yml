name: üöÄ Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  SERVER_PATH: /data/www/moov-universe

jobs:
  deploy:
    name: üöÄ Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      - name: üü¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: üì¶ Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: üèóÔ∏è Build frontend
        working-directory: ./frontend
        env:
          VITE_API_URL: ${{ secrets.API_URL }}
        run: npm run build
      
      - name: üîê Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # Configure SSH to avoid host key checking for automated deployment
          cat >> ~/.ssh/config << 'SSHCONFIG'
          Host ${{ secrets.SERVER_HOST }}
            StrictHostKeyChecking accept-new
            UserKnownHostsFile ~/.ssh/known_hosts
          SSHCONFIG
      
      - name: üöÄ Deploy backend
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd ${{ env.SERVER_PATH }}
            
            # Update code from Git
            git fetch origin main
            git reset --hard origin/main
            
            # Backend deployment
            cd backend
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Laravel optimizations
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache
            
            # Clear obsolete caches
            php artisan cache:clear
            
            # Create storage links
            php artisan storage:link 2>/dev/null || true
            
            # Run migrations
            php artisan migrate --force
            
            # Fix permissions
            sudo chown -R ${{ secrets.SERVER_USER }}:${{ secrets.SERVER_USER }} storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
          EOF
      
      - name: üì§ Deploy frontend
        run: |
          rsync -avz --delete \
            ./frontend/dist/ \
            ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:${{ env.SERVER_PATH }}/frontend/dist/
      
      - name: ‚ôªÔ∏è Restart services
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            # Reload Nginx if active
            if systemctl is-active --quiet nginx; then
              sudo systemctl reload nginx
            fi
            
            # Restart PHP-FPM (try different versions in order of preference)
            for php_version in php8.3-fpm php8.2-fpm php8.1-fpm php-fpm; do
              if systemctl is-active --quiet $php_version 2>/dev/null; then
                sudo systemctl restart $php_version
                break
              fi
            done
          EOF
      
      - name: ‚úÖ Deployment complete
        run: |
          echo "üéâ Deployment completed successfully!"
          echo "üìÖ Date: $(date '+%Y-%m-%d %H:%M:%S')"

# Required GitHub Secrets:
# - SERVER_HOST: IP or domain of the production server (e.g., 10.80.16.51)
# - SERVER_USER: SSH user for connection (e.g., moov)
# - SSH_PRIVATE_KEY: Private SSH key for authentication
# - API_URL: API URL for the frontend (e.g., https://10.80.16.51:8443/api)
